name: Quality Assurance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Code quality checks
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@v1

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Run Black formatter check
      run: poetry run black --check --diff services/ shared/ tests/

    - name: Run isort import sorting check
      run: poetry run isort --check-only --diff services/ shared/ tests/

    - name: Run flake8 linting
      run: poetry run flake8 services/ shared/ tests/ --statistics

    - name: Run pylint
      continue-on-error: true
      run: poetry run pylint services/ shared/ --output-format=json --reports=y > pylint-report.json || true

    - name: Run mypy type checking
      run: poetry run mypy services/ shared/ --junit-xml=mypy-report.xml

    - name: Upload quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: |
          pylint-report.json
          mypy-report.xml

  # Test coverage analysis
  test-coverage:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: inventory_management_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@v1

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Set up environment variables
      run: |
        echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/inventory_management_test" >> $GITHUB_ENV
        echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
        echo "JWT_SECRET_KEY=test-secret-key" >> $GITHUB_ENV
        echo "LOG_LEVEL=INFO" >> $GITHUB_ENV
        echo "ENVIRONMENT=test" >> $GITHUB_ENV

    - name: Run database migrations
      run: poetry run alembic upgrade head

    - name: Run tests with coverage
      run: |
        poetry run pytest \
          --cov=services \
          --cov=shared \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=18 \
          --junitxml=pytest-report.xml \
          --ignore=tests/property \
          tests/unit/ tests/integration/

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true

    - name: Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          coverage.xml
          htmlcov/
          pytest-report.xml

  # Performance testing
  performance-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: inventory_management_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@v1

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Set up environment variables
      run: |
        echo "DATABASE_URL=postgresql://test_user:test_password@localhost:5432/inventory_management_test" >> $GITHUB_ENV
        echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
        echo "JWT_SECRET_KEY=test-secret-key" >> $GITHUB_ENV
        echo "LOG_LEVEL=INFO" >> $GITHUB_ENV
        echo "ENVIRONMENT=test" >> $GITHUB_ENV

    - name: Run database migrations
      run: poetry run alembic upgrade head

    - name: Start services for performance testing
      run: |
        # Start services in background for performance testing
        poetry run uvicorn services.api_gateway.main:app --host 0.0.0.0 --port 8000 &
        poetry run uvicorn services.inventory.main:app --host 0.0.0.0 --port 8001 &
        poetry run uvicorn services.location.main:app --host 0.0.0.0 --port 8002 &
        poetry run uvicorn services.user.main:app --host 0.0.0.0 --port 8003 &
        poetry run uvicorn services.reporting.main:app --host 0.0.0.0 --port 8004 &
        
        # Wait for services to start
        sleep 30

    - name: Install Apache Bench
      run: sudo apt-get update && sudo apt-get install -y apache2-utils

    - name: Run performance tests
      run: |
        # Test API Gateway health endpoint
        ab -n 1000 -c 10 http://localhost:8000/health > ab-api-gateway.txt
        
        # Test other service health endpoints
        ab -n 1000 -c 10 http://localhost:8001/health > ab-inventory.txt
        ab -n 1000 -c 10 http://localhost:8002/health > ab-location.txt
        ab -n 1000 -c 10 http://localhost:8003/health > ab-user.txt
        ab -n 1000 -c 10 http://localhost:8004/health > ab-reporting.txt

    - name: Upload performance reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-reports
        path: |
          ab-*.txt

  # Documentation quality check
  documentation-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install Poetry
      uses: snok/install-poetry@v1

    - name: Install dependencies
      run: poetry install --no-interaction

    - name: Check docstring coverage
      continue-on-error: true
      run: |
        poetry run docstr-coverage services/ shared/ --badge=docstring-coverage.svg --fail-under=70 || echo "Docstring coverage check failed, continuing..."

    - name: Generate API documentation
      run: |
        # Generate OpenAPI specs for each service
        mkdir -p docs/api
        
        # This would generate API docs - placeholder for now
        echo "API documentation generation would go here"

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: documentation
        path: |
          docstring-coverage.svg
          docs/

  # Quality gate summary
  quality-gate:
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, performance-test, documentation-check]
    if: always()
    
    steps:
    - name: Quality gate evaluation
      continue-on-error: true
      run: |
        echo "# Quality Gate Summary" > quality-gate.md
        echo "" >> quality-gate.md
        echo "## Results" >> quality-gate.md
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> quality-gate.md
        echo "- Test Coverage: ${{ needs.test-coverage.result }}" >> quality-gate.md
        echo "- Performance Test: ${{ needs.performance-test.result }}" >> quality-gate.md
        echo "- Documentation Check: ${{ needs.documentation-check.result }}" >> quality-gate.md
        echo "" >> quality-gate.md
        
        # Determine overall quality gate status (lenient - only fail on critical issues)
        if [[ "${{ needs.code-quality.result }}" == "failure" || 
              "${{ needs.test-coverage.result }}" == "failure" ]]; then
          echo "## Status: ⚠️ WARNING" >> quality-gate.md
          echo "Some quality checks failed. Please review issues." >> quality-gate.md
        else
          echo "## Status: ✅ PASSED" >> quality-gate.md
          echo "Core quality checks passed successfully." >> quality-gate.md
        fi

    - name: Upload quality gate report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-gate-report
        path: quality-gate.md